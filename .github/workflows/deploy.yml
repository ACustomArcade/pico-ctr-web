name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      firmware_repo:
        description: 'Firmware release repo (owner/name)'
        required: false
        default: ''

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

# Default firmware source repo â€” change this to pull from a different release
env:
  FIRMWARE_REPO: ${{ github.event.inputs.firmware_repo || 'ACustomArcade/pico-ctr-web' }}

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download firmware from latest release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          mkdir -p firmware

          REPO="${FIRMWARE_REPO}"
          echo "Fetching latest release from ${REPO}..."

          # Get latest release JSON
          RELEASE_JSON=$(gh api "repos/${REPO}/releases/latest" 2>/dev/null || echo "")

          if [ -z "$RELEASE_JSON" ] || echo "$RELEASE_JSON" | jq -e '.message' >/dev/null 2>&1; then
            echo "::warning::No releases found in ${REPO}. Deploying without firmware."
            echo '{"firmware":{},"release":{"tag":"none","date":"","repo":"'${REPO}'"}}' > firmware/manifest.json
            exit 0
          fi

          TAG=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          DATE=$(echo "$RELEASE_JSON" | jq -r '.published_at')
          HTML_URL=$(echo "$RELEASE_JSON" | jq -r '.html_url')
          echo "Found release: ${TAG} (${DATE})"

          # Download all .uf2 assets
          ASSETS=$(echo "$RELEASE_JSON" | jq -c '.assets[] | select(.name | endswith(".uf2"))')
          COUNT=0

          while IFS= read -r asset; do
            [ -z "$asset" ] && continue
            NAME=$(echo "$asset" | jq -r '.name')
            URL=$(echo "$asset" | jq -r '.url')
            echo "  Downloading ${NAME}..."
            gh api "$URL" -H "Accept: application/octet-stream" > "firmware/${NAME}"
            COUNT=$((COUNT + 1))
          done <<< "$ASSETS"

          echo "Downloaded ${COUNT} firmware files"

          # Try to download firmware.json from release assets (auto-generated by firmware build)
          MANIFEST_ASSET=$(echo "$RELEASE_JSON" | jq -c '.assets[] | select(.name == "firmware.json")' 2>/dev/null)
          if [ -n "$MANIFEST_ASSET" ]; then
            MANIFEST_URL=$(echo "$MANIFEST_ASSET" | jq -r '.url')
            echo "Downloading firmware.json from release assets..."
            gh api "$MANIFEST_URL" -H "Accept: application/octet-stream" > firmware/release-firmware.json
            # Merge release metadata into the downloaded manifest
            jq --arg tag "$TAG" --arg date "$DATE" --arg url "$HTML_URL" --arg repo "$REPO" \
              '. + {release: {tag: $tag, date: $date, url: $url, repo: $repo}}' \
              firmware/release-firmware.json > firmware/manifest.json
            rm -f firmware/release-firmware.json
          elif [ -f "firmware.json" ]; then
            # Fallback: use committed firmware.json at repo root
            echo "No firmware.json in release assets, using committed firmware.json..."
            jq --arg tag "$TAG" --arg date "$DATE" --arg url "$HTML_URL" --arg repo "$REPO" \
              '. + {release: {tag: $tag, date: $date, url: $url, repo: $repo}}' \
              firmware.json > firmware/manifest.json
          else
            echo "No firmware.json found, generating manifest from downloaded files..."
            # Generate a basic manifest grouped by filename prefix as manufacturer
            FILES_JSON=$(ls firmware/*.uf2 2>/dev/null | while read f; do
              basename "$f" | jq -R '{file: ., name: (. | sub("\\.uf2$";"") | split("-")[2:] | map(. / "" | first |= ascii_upcase | join("")) | join(" ")), dev: false}'
            done | jq -s '{Other: .}')
            jq -n --arg tag "$TAG" --arg date "$DATE" --arg url "$HTML_URL" --arg repo "$REPO" \
              --argjson fw "$FILES_JSON" \
              '{firmware: $fw, release: {tag: $tag, date: $date, url: $url, repo: $repo}}' \
              > firmware/manifest.json
          fi

          echo "Manifest:"
          cat firmware/manifest.json

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
