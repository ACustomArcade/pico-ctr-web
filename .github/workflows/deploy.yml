name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  release:
    types: [published, edited]
  workflow_dispatch:
    inputs:
      firmware_repo:
        description: 'Firmware release repo (owner/name)'
        required: false
        default: ''

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

# Default firmware source repo — change this to pull from a different release
env:
  FIRMWARE_REPO: ${{ github.event.inputs.firmware_repo || 'ACustomArcade/pico-ctr-web' }}

jobs:
  deploy:
    # Skip pre-releases — only deploy when the release is marked as latest
    if: github.event_name != 'release' || (!github.event.release.prerelease && github.event.release.draft == false)
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download firmware from latest release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          mkdir -p firmware

          REPO="${FIRMWARE_REPO}"
          echo "Fetching latest release from ${REPO}..."

          # Get latest release JSON
          RELEASE_JSON=$(gh api "repos/${REPO}/releases/latest" 2>/dev/null || echo "")

          if [ -z "$RELEASE_JSON" ] || echo "$RELEASE_JSON" | jq -e '.message' >/dev/null 2>&1; then
            echo "::warning::No releases found in ${REPO}. Deploying without firmware."
            echo '{"version":"","date":"","firmware":{}}' > firmware/firmware.json
            exit 0
          fi

          TAG=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          DATE=$(echo "$RELEASE_JSON" | jq -r '.published_at')
          echo "Found release: ${TAG} (${DATE})"

          # Extract version from tag (strip leading 'v')
          VERSION=$(echo "$TAG" | sed 's/^v//' | grep -oE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?' || echo "")
          RELEASE_DATE=$(echo "$DATE" | cut -dT -f1)
          echo "Version: ${VERSION}, Date: ${RELEASE_DATE}"

          # Download all .uf2 assets
          ASSETS=$(echo "$RELEASE_JSON" | jq -c '.assets[] | select(.name | endswith(".uf2"))')
          COUNT=0

          while IFS= read -r asset; do
            [ -z "$asset" ] && continue
            NAME=$(echo "$asset" | jq -r '.name')
            URL=$(echo "$asset" | jq -r '.url')
            echo "  Downloading ${NAME}..."
            gh api "$URL" -H "Accept: application/octet-stream" > "firmware/${NAME}"
            COUNT=$((COUNT + 1))
          done <<< "$ASSETS"

          echo "Downloaded ${COUNT} firmware files"

          # Try to download firmware.json from release assets (auto-generated by firmware build)
          MANIFEST_ASSET=$(echo "$RELEASE_JSON" | jq -c '.assets[] | select(.name == "firmware.json")' 2>/dev/null)
          if [ -n "$MANIFEST_ASSET" ]; then
            MANIFEST_URL=$(echo "$MANIFEST_ASSET" | jq -r '.url')
            echo "Downloading firmware.json from release assets..."
            gh api "$MANIFEST_URL" -H "Accept: application/octet-stream" > firmware/firmware.json
            echo "Using firmware.json from release (already contains version metadata)"
          else
            echo "No firmware.json in release assets, generating manifest from downloaded files..."
            # Generate a basic manifest from downloaded UF2 files
            FILES_JSON=$(ls firmware/*.uf2 2>/dev/null | while read f; do
              basename "$f" | jq -R '{file: ., name: (. | sub("\\.uf2$";"") | split("-")[2:] | map(. / "" | first |= ascii_upcase | join("")) | join(" ")), dev: false}'
            done | jq -s '{Other: .}')
            jq -n --arg ver "$VERSION" --arg date "$RELEASE_DATE" \
              --argjson fw "$FILES_JSON" \
              '{version: $ver, date: $date, firmware: $fw}' \
              > firmware/firmware.json
          fi

          echo "Firmware manifest:"
          cat firmware/firmware.json

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
