<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicoCTR Web Configurator</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÆ</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>üéÆ PicoCTR Web Configurator</h1>
            <p class="subtitle">Configure your PicoCTR arcade controller via USB</p>
        </div>
    </header>

    <main>
        <!-- Browser Support Warning -->
        <div id="browser-warning" class="card warning-card" style="display: none;">
            <h2>‚ö†Ô∏è Browser Not Supported</h2>
            <p>WebUSB is required for USB communication. Please use <strong>Google Chrome</strong> or <strong>Microsoft Edge</strong> (version 89+).</p>
        </div>

        <!-- Connection Section -->
        <section id="connection-section" class="card">
            <h2>Connect Device</h2>
            <p>Plug in your PicoCTR controller and click the button below to connect.</p>
            <div class="connect-actions">
                <button id="btn-connect" class="btn btn-primary btn-large">
                    <span class="btn-icon">üîå</span>
                    Connect PicoCTR
                </button>
                <button id="btn-disconnect" class="btn btn-secondary" style="display: none;">
                    Disconnect
                </button>
            </div>
            <div id="connection-status" class="status-bar">
                <span class="status-dot disconnected"></span>
                <span class="status-text">Not connected</span>
            </div>
            <div id="bootstrap-link" class="bootstrap-link">
                <span>New device without firmware?</span>
                <button id="btn-bootstrap" class="btn btn-ghost btn-small">
                    <span class="btn-icon">üÜï</span> Setup New Device
                </button>
            </div>
        </section>

        <!-- Device Info Section -->
        <section id="device-info-section" class="card" style="display: none;">
            <h2>Device Information</h2>
            <div class="info-grid">
                <div class="info-item">
                    <label>Board</label>
                    <span id="info-board">‚Äî</span>
                </div>
                <div class="info-item">
                    <label>Variant</label>
                    <span id="info-variant">‚Äî</span>
                </div>
                <div class="info-item">
                    <label>Firmware Version</label>
                    <span id="info-version">‚Äî</span>
                </div>
                <div class="info-item">
                    <label>Build Type</label>
                    <span id="info-build-type">‚Äî</span>
                </div>
                <div class="info-item">
                    <label>USB ID</label>
                    <span id="info-usb-id">‚Äî</span>
                </div>
                <div class="info-item">
                    <label>Gamepads</label>
                    <span id="info-gamepads">‚Äî</span>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings-section" class="card" style="display: none;">
            <h2>RGB Settings</h2>
            <div id="unsaved-banner" class="unsaved-banner" style="display: none;">
                <span>‚ö° Device has unsaved changes &mdash; use <strong>Save to Flash</strong> to persist them</span>
            </div>

            <div class="settings-form">
                <!-- RGB Enable -->
                <div class="form-group">
                    <label for="setting-enable_rgb">RGB Enabled</label>
                    <div class="toggle-wrapper">
                        <input type="checkbox" id="setting-enable_rgb" class="toggle-input" data-field="enable_rgb">
                        <label for="setting-enable_rgb" class="toggle-label"></label>
                    </div>
                </div>

                <!-- Animation -->
                <div class="form-group">
                    <label for="setting-rgb_animation">Animation</label>
                    <select id="setting-rgb_animation" class="form-select" data-field="rgb_animation">
                        <!-- Populated from config -->
                    </select>
                </div>

                <!-- Color Picker -->
                <div class="form-group form-group-vertical" id="color-group">
                    <label>Solid Color</label>
                    <div class="color-picker-container">
                        <div id="iro-picker"></div>
                        <div class="color-rgb-inputs">
                            <div class="color-channel">
                                <label for="setting-rgb_color_r">R</label>
                                <input type="number" id="setting-rgb_color_r" class="form-input-small" min="0" max="255" data-field="rgb_r">
                            </div>
                            <div class="color-channel">
                                <label for="setting-rgb_color_g">G</label>
                                <input type="number" id="setting-rgb_color_g" class="form-input-small" min="0" max="255" data-field="rgb_g">
                            </div>
                            <div class="color-channel">
                                <label for="setting-rgb_color_b">B</label>
                                <input type="number" id="setting-rgb_color_b" class="form-input-small" min="0" max="255" data-field="rgb_b">
                            </div>
                            <div class="color-hex" id="color-hex-display">#ff0000</div>
                        </div>
                    </div>
                </div>

                <!-- LED Count -->
                <div class="form-group">
                    <label for="setting-led_count">LED Count</label>
                    <input type="number" id="setting-led_count" class="form-input" min="1" max="255" data-field="led_count">
                </div>

                <!-- Brightness -->
                <div class="form-group">
                    <label for="setting-led_brightness">Brightness</label>
                    <div class="slider-wrapper">
                        <input type="range" id="setting-led_brightness" class="form-range" min="0" max="255" data-field="led_brightness">
                        <span id="brightness-value" class="range-value">0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Button Mapping Section -->
        <section id="pin-mapping-section" class="card" style="display: none;">
            <details id="button-mapping-accordion" class="mapping-accordion">
                <summary class="mapping-accordion-header">
                    <h2>Button Mapping</h2>
                    <span class="accordion-hint">Click to expand</span>
                </summary>
                <p class="section-desc">Remap what each button does. Changes are applied with the Apply button below.</p>
                <div class="mapping-toolbar">
                    <button id="btn-mapping-export" class="btn btn-ghost btn-small" title="Export mapping to file">
                        <span class="btn-icon">üì§</span> Export
                    </button>
                    <button id="btn-mapping-import" class="btn btn-ghost btn-small" title="Import mapping from file">
                        <span class="btn-icon">üì•</span> Import
                    </button>
                    <input type="file" id="mapping-file-input" accept=".json" style="display: none;">
                </div>
                <div class="pin-mapping-table-wrapper">
                    <table class="pin-mapping-table">
                        <thead>
                            <tr>
                                <th class="pin-col-label">Button</th>
                                <th class="pin-col-type">Output Type</th>
                                <th class="pin-col-target">Target</th>
                                <th class="pin-col-code">Code</th>
                            </tr>
                        </thead>
                        <tbody id="pin-mapping-body"></tbody>
                    </table>
                </div>
            </details>
        </section>

        <!-- Actions Section -->
        <section id="actions-section" class="card" style="display: none;">
            <h2>Actions</h2>
            <div class="action-buttons">
                <button id="btn-apply" class="btn btn-primary" title="Send settings to device (preview without saving)">
                    <span class="btn-icon">‚ö°</span> Apply
                </button>
                <button id="btn-undo" class="btn btn-secondary" title="Discard unsaved changes by rebooting the device">
                    <span class="btn-icon">‚Ü©Ô∏è</span> Undo Changes
                </button>
            </div>
            <div class="action-buttons">
                <button id="btn-read" class="btn btn-secondary" title="Re-read settings from device">
                    <span class="btn-icon">üîÑ</span> Refresh
                </button>
                <button id="btn-reset" class="btn btn-warning" title="Reset to factory defaults">
                    <span class="btn-icon">üîß</span> Reset Defaults
                </button>
                <button id="btn-bootsel" class="btn btn-danger" title="Reboot into flash mode for firmware update (device will disconnect)">
                    <span class="btn-icon">üì¶</span> Update Firmware
                </button>
            </div>
        </section>

        <!-- Firmware Update Section -->
        <section id="firmware-section" class="card" style="display: none;">
            <h2>Firmware Update</h2>
            <p class="firmware-description">
                Flash new firmware directly from your browser.
                The device must be in flash mode ‚Äî hold the BOOT button while plugging it in, or use the Update Firmware button above.
            </p>

            <div id="fw-windows-help" class="fw-windows-help" style="display: none;">
                <details>
                    <summary>‚ö†Ô∏è Windows: USB driver setup required</summary>
                    <p>
                        Windows requires the <strong>WinUSB</strong> driver for the flash mode interface.
                        Without it, the browser cannot communicate with the device.
                    </p>
                    <ol>
                        <li>Download and run <a href="https://zadig.akeo.ie/" target="_blank" rel="noopener">Zadig</a></li>
                        <li>Put your device in flash mode (hold BOOT while plugging in)</li>
                        <li>In Zadig, select <strong>Options ‚Üí List All Devices</strong></li>
                        <li>Select <strong>"RP2 Boot (Interface 1)"</strong> from the dropdown</li>
                        <li>Set the driver to <strong>WinUSB</strong> and click <strong>Replace Driver</strong></li>
                        <li>Unplug and re-plug the device, then try again</li>
                    </ol>
                    <p class="fw-windows-alt">
                        <strong>Alternative:</strong> You can also flash by dragging the .uf2 file onto the
                        <strong>RPI-RP2</strong> drive that appears in File Explorer when in flash mode.
                    </p>
                </details>
            </div>

            <div class="firmware-steps">
                <!-- Step 1: Connect device in flash mode -->
                <div class="firmware-step" id="fw-step-connect">
                    <div class="step-header">
                        <span class="step-number">1</span>
                        <span class="step-title">Connect device in flash mode</span>
                    </div>
                    <div class="step-content">
                        <button id="btn-fw-connect" class="btn btn-primary">
                            <span class="btn-icon">üîå</span> Connect Device
                        </button>
                        <div id="fw-connect-status" class="fw-connect-status" style="display: none;"></div>
                        <div id="fw-device-info" class="fw-device-info" style="display: none;">
                            <span class="status-dot connected"></span>
                            <span id="fw-device-name">‚Äî</span>
                        </div>
                        <div id="fw-installed-info" class="fw-installed-info" style="display: none;">
                            <div class="fw-installed-header">Currently Installed</div>
                            <div class="fw-info-row" id="fw-installed-row-variant" style="display: none;">
                                <span>Variant:</span><span id="fw-installed-variant">‚Äî</span>
                            </div>
                            <div class="fw-info-row" id="fw-installed-row-board" style="display: none;">
                                <span>Board:</span><span id="fw-installed-board">‚Äî</span>
                            </div>
                            <div class="fw-info-row" id="fw-installed-row-version" style="display: none;">
                                <span>Version:</span><span id="fw-installed-version">‚Äî</span>
                            </div>
                            <div class="fw-info-row" id="fw-installed-row-git" style="display: none;">
                                <span>Git:</span><span id="fw-installed-git">‚Äî</span>
                            </div>
                            <div id="fw-installed-loading" class="fw-installed-loading">
                                <span class="spinner"></span> Reading installed firmware...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Select UF2 file -->
                <div class="firmware-step fw-step-hidden" id="fw-step-file">
                    <div class="step-header">
                        <span class="step-number">2</span>
                        <span class="step-title">Select firmware</span>
                    </div>
                    <div class="step-content">
                        <!-- Firmware release list (loaded from same-origin /firmware/) -->
                        <div id="fw-release-loading" class="fw-release-loading">
                            <span class="spinner"></span> Loading available firmware...
                        </div>
                        <div id="fw-release-error" class="fw-release-error" style="display: none;">
                            <span id="fw-release-error-msg">Failed to load firmware</span>
                            <a id="fw-release-fallback-link" href="#" target="_blank" rel="noopener">
                                Download from GitHub manually ‚Üí
                            </a>
                        </div>
                        <div id="fw-release-content" style="display: none;">
                            <div class="fw-release-header">
                                <span id="fw-release-tag" class="fw-release-tag"></span>
                                <span id="fw-release-date" class="fw-release-date"></span>
                                <a id="fw-release-link" class="fw-release-link" href="#" target="_blank" rel="noopener">View release ‚Üí</a>
                            </div>
                            <div id="fw-release-list" class="fw-release-list">
                                <!-- Firmware asset items populated by JS -->
                            </div>
                        </div>

                        <!-- Local file fallback -->
                        <div class="fw-local-fallback">
                            <input type="file" id="fw-file-input" accept=".uf2" style="display: none;">
                            <span class="fw-local-or">or</span>
                            <button id="btn-fw-browse" class="btn btn-ghost btn-small" disabled>
                                <span class="btn-icon">üìÅ</span> Load local .uf2 file
                            </button>
                        </div>

                        <!-- Firmware info -->
                        <div id="fw-file-info" class="fw-file-info" style="display: none;">
                            <div class="fw-info-row" id="fw-info-row-board" style="display: none;">
                                <span>Board:</span><span id="fw-info-board">‚Äî</span>
                            </div>
                            <div class="fw-info-row" id="fw-info-row-variant" style="display: none;">
                                <span>Variant:</span><span id="fw-info-variant">‚Äî</span>
                            </div>
                            <div class="fw-info-row" id="fw-info-row-version" style="display: none;">
                                <span>Firmware Version:</span><span id="fw-info-version">‚Äî</span>
                            </div>
                            <div class="fw-info-row" id="fw-info-row-git" style="display: none;">
                                <span>Git:</span><span id="fw-info-git">‚Äî</span>
                            </div>
                            <div class="fw-info-row"><span>Size:</span><span id="fw-info-size">‚Äî</span></div>
                        </div>

                        <!-- Non-PicoCTR error -->
                        <div id="fw-validation-warning" class="fw-validation-error" style="display: none;">
                            üö´ <strong>Error:</strong> This UF2 file does not appear to be PicoCTR firmware.
                        </div>
                    </div>
                </div>

                <!-- Step 3: Flash -->
                <div class="firmware-step fw-step-hidden" id="fw-step-flash">
                    <div class="step-header">
                        <span class="step-number">3</span>
                        <span class="step-title">Flash firmware</span>
                    </div>
                    <div class="step-content">
                        <button id="btn-fw-flash" class="btn btn-danger btn-large" disabled>
                            <span class="btn-icon">‚ö°</span> Flash Firmware
                        </button>
                        <div id="fw-progress-container" class="fw-progress-container" style="display: none;">
                            <div class="fw-progress-bar">
                                <div id="fw-progress-fill" class="fw-progress-fill" style="width: 0%"></div>
                            </div>
                            <div id="fw-progress-text" class="fw-progress-text">Waiting...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="fw-platform-note" class="fw-platform-note">
                <strong>Note:</strong> On Windows, you may need to install a WinUSB driver for the flash mode device
                using <a href="https://zadig.akeo.ie/" target="_blank" rel="noopener">Zadig</a>.
                Linux and macOS typically work without additional drivers.
            </div>

            <div class="fw-return">
                <button id="btn-fw-return" class="btn btn-secondary">
                    <span class="btn-icon">‚Ü©Ô∏è</span> Return to Config Mode
                </button>
            </div>
        </section>

        <!-- Log Section -->
        <section id="log-section" class="card">
            <h2>
                Activity Log
                <button id="btn-clear-log" class="btn btn-small btn-ghost">Clear</button>
            </h2>
            <div id="log-output" class="log-output">
                <div class="log-entry log-info">Ready. Connect a PicoCTR device to begin.</div>
            </div>
        </section>
    </main>

    <footer>
        <p>PicoCTR Web Configurator</p>
        <p class="footer-note">Requires Chrome or Edge with WebUSB support</p>
    </footer>

    <!-- Apply Confirmation Dialog -->
    <dialog id="apply-dialog" class="modal-dialog">
        <div class="modal-content">
            <h3>Apply Settings</h3>
            <p>Choose how to apply your changes:</p>
            <p><strong>Preview</strong> &mdash; applies settings immediately, but they will revert when the device restarts.</p>
            <p><strong>Save to Flash</strong> &mdash; applies settings and saves them permanently.</p>
            <div class="modal-actions">
                <button id="apply-dialog-cancel" class="btn btn-secondary">Cancel</button>
                <button id="apply-dialog-confirm" class="btn btn-primary">Preview</button>
                <button id="apply-dialog-save" class="btn btn-success">Save to Flash</button>
            </div>
        </div>
    </dialog>

    <script src="js/picoboot.js"></script>
    <script src="js/webusb.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
